<!DOCTYPE html>
<html>
    <head>
        <script></script>
    </head>
    <body>
        <script>
            window.ReactNativeWebView.postMessage(JSON.stringify({ response: "Initializing pouchdb" }));

            // Encrypt data using AES-256-CBC
            function encryptData(data, encryptionKey) {
                const dataHex = stohex(data);
                const keyHex = b64tohex(encryptionKey); // Convert Base64 key to Hex
                const ivHex = KJUR.crypto.Util.getRandomHexOfNbytes(16); // Generate a random IV (16 bytes for CBC)
                const encryptedHex = KJUR.crypto.Cipher.encrypt(dataHex, keyHex, "aes256-CBC", { iv: ivHex });

                // Return IV + CipherText as Base64 for transport
                return hextob64(ivHex + encryptedHex);
            }

            // Decrypt data using AES-256-CBC
            function decryptData(encryptedData, encryptionKey) {
                const encryptedHex = b64tohex(encryptedData); // Convert Base64 to Hex
                const ivHex = encryptedHex.slice(0, 32); // Extract IV (first 16 bytes in Hex)
                const cipherTextHex = encryptedHex.slice(32); // Extract CipherText (remaining bytes)
                const keyHex = b64tohex(encryptionKey); // Convert Base64 key to Hex
                const decryptedHex = KJUR.crypto.Cipher.decrypt(cipherTextHex, keyHex, "aes256-CBC", { iv: ivHex });

                // Convert decrypted hex to string
                const plaintext = hextorstr(decryptedHex);
                return plaintext;
            }

            // Function to generate RSA keys
            function generateRSAKeys() {
                // Generate a new RSA key pair with a 2048-bit key size
                const keyPair = KEYUTIL.generateKeypair("RSA", 2048);

                // Convert the private key to PEM format (PKCS#8)
                const privateKeyPEM = KEYUTIL.getPEM(keyPair.prvKeyObj, "PKCS8PRV");

                // Convert the public key to PEM format (PKCS#8)
                const publicKeyPEM = KEYUTIL.getPEM(keyPair.pubKeyObj);

                return { publicKey: publicKeyPEM, privateKey: privateKeyPEM };
            }

            // Function to sign a challenge
            function signChallenge(privateKeyPem, challenge) {
                // Initialize the private key object from the PEM string
                const privateKey = KEYUTIL.getKey(privateKeyPem);

                // Create a new Signature object with the specified algorithm
                const signature = new KJUR.crypto.Signature({ alg: "SHA256withRSA" });

                // Initialize the Signature object with the private key
                signature.init(privateKey);

                // Update the Signature object with the challenge string
                signature.updateString(challenge);

                // Sign the challenge and get the signature in hexadecimal format
                const signedHex = signature.sign();

                // Convert the hexadecimal signature to Base64 encoding
                const signedBase64 = hextob64(signedHex);
                return signedBase64;
            }

            // Listener for React Native messages
            window.addEventListener("message", (event) => {
                const { action, payload, requestId } = event.data;

                try {
                    let response;
                    if (action === "generateRSAKeys") {
                        response = generateRSAKeys();
                    } else if (action === "signChallenge") {
                        const { privateKey, challenge } = payload;
                        response = signChallenge(privateKey, challenge);
                    } else if (action === "encryptData") {
                        const { data, encryptionKey } = payload;
                        response = encryptData(data, encryptionKey);
                    } else if (action === "decryptData") {
                        const { encryptedData, encryptionKey } = payload;
                        response = decryptData(encryptedData, encryptionKey);
                    }

                    // Respond back to React Native
                    window.ReactNativeWebView.postMessage(JSON.stringify({ requestId, response }));
                } catch (error) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({ requestId, error: error.message }));
                }
            });
            window.ReactNativeWebView.postMessage(JSON.stringify({ response: "Done." }));
        </script>
    </body>
</html>
