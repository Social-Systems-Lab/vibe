# Vibe Cloud SaaS: Implementation Specification

This document provides a comprehensive specification for building the new Vibe Cloud multi-tenant SaaS platform from scratch. It is designed to be a clear blueprint for implementation.

## 1. Core Vision & Principles

-   **Architecture**: A centralized, multi-tenant SaaS platform.
-   **Authentication**: Standard email/password sign-up and login.
-   **Identity Model**: Hosted identities, where user keys are generated by the server and encrypted with a key derived from the user's password.
-   **Hosting**: All infrastructure will be provisioned on Scaleway using Infrastructure as Code.
-   **Initial Focus**: The backend API and a user-facing web interface for account management. The `vibe-sdk` and `vibe-agent` are out of scope for the initial build.

## 2. Simplified Project Structure

We will adopt a simplified monorepo structure. The previous separation of `api`, `control-plane`, and `infra` will be consolidated.

```
vibe-cloud/
├── infra/                  # All Infrastructure as Code (Terraform)
│   ├── main.tf
│   ├── variables.tf
│   └── modules/
│       ├── database.tf     # CouchDB setup
│       └── kubernetes.tf   # K8s cluster and app deployment setup
├── packages/
│   ├── api/                # The monolithic backend service
│   │   ├── src/
│   │   │   ├── services/   # Identity, Groups, Data, Blob services
│   │   │   ├── models/
│   │   │   └── index.ts    # ElysiaJS server setup
│   │   ├── Dockerfile
│   │   └── package.json
│   └── web/                # The user-facing web interface
│       ├── src/
│       │   ├── pages/      # Login, Signup, Dashboard pages
│       │   ├── components/
│       │   └── main.tsx    # React app entry point
│       ├── Dockerfile
│       └── package.json
├── docker-compose.yml      # For local development environment
└── package.json            # Root package.json for monorepo workspace
```

## 3. Technology Stack

| Category         | Technology                        | Role                                                    |
| :--------------- | :-------------------------------- | :------------------------------------------------------ |
| Runtime          | **Bun**                           | Executes server-side and client-side JS/TS.             |
| Backend          | **ElysiaJS**                      | High-performance framework for the `api` service.       |
| Frontend         | **React (Vite)**                  | For building the `web` user interface.                  |
| Database         | **Apache CouchDB**                | Primary data store for user data, groups, and metadata. |
| Blob Storage     | **Scaleway Object Storage (S3)**  | For storing large binary files.                         |
| Infrastructure   | **Terraform**                     | For provisioning all cloud resources on Scaleway (IaC). |
| Containerization | **Docker**                        | Packages the `api` and `web` services for deployment.   |
| Deployment       | **Kubernetes (Scaleway Kapsule)** | Orchestrates the deployed containers.                   |

## 4. Infrastructure Specification (infra/)

The Terraform configuration will provision the following Scaleway resources:

1.  **VPC**: A Virtual Private Cloud to contain all resources.
2.  **Kubernetes Cluster (Kapsule)**: A managed K8s cluster to run our services.
3.  **Managed Database for CouchDB**: A managed instance of CouchDB. If not available, a VM instance with CouchDB installed via a startup script.
4.  **Object Storage Bucket**: A single S3 bucket for all users' blobs, with data isolated by key prefixes (e.g., `user-id-123/profile.jpg`).
5.  **Container Registry**: To store the Docker images for the `api` and `web` services.
6.  **Load Balancer**: To expose the `web` service and the `api` service to the internet, managing traffic and TLS termination.

## 5. Backend API Specification (`packages/api/`)

The `api` service will be a monolithic ElysiaJS application implementing the endpoints defined in `APISpecification.md`. This includes:

-   **Identity Service Logic**:
    -   `POST /register`: Handles user creation, password hashing (Argon2/scrypt), salt generation, mnemonic generation, and encryption of the mnemonic. Provisions a new database for the user in CouchDB.
    -   `POST /login`: Verifies credentials, re-derives the encryption key, decrypts the mnemonic, and issues a short-lived JWT containing the mnemonic.
-   **Groups Service Logic**:
    -   CRUD endpoints for managing user groups (`/groups`, `/groups/{id}/members`).
-   **Data & Permissions API Logic**:
    -   CRUD endpoints for user data (`/data/{collection}`).
    -   Endpoints for blob storage (`/blob/upload-url`, `/blob/finalize-upload`, `/blob/download-url/{blobId}`).

## 6. Web Interface Specification (`packages/web/`)

The `web` service will be a React application providing the user-facing interface for account management.

-   **Key Pages**:
    -   `/register`: A sign-up form that calls the `api/register` endpoint.
    -   `/login`: A login form that calls the `api/login` endpoint and stores the returned JWT in memory or `sessionStorage`.
    -   `/dashboard`: A protected route that shows basic user information and could be expanded to manage groups or data.
-   **API Interaction**: Use a library like `axios` or `fetch` to communicate with the backend API, attaching the JWT to the `Authorization` header for all protected requests.

## 7. High-Level Implementation Plan

This plan can be followed to build the system from the ground up.

1.  **Step 1: Project Scaffolding**:

    -   Initialize a new monorepo with Bun workspaces.
    -   Create the directory structure as defined in Section 2.
    -   Initialize `package.json` files for the `api` and `web` packages.

2.  **Step 2: Local Development Environment**:

    -   Create the `docker-compose.yml` file to run CouchDB locally for development.

3.  **Step 3: Infrastructure as Code**:

    -   Write the Terraform scripts (`infra/`) to provision the Scaleway resources defined in Section 4.

4.  **Step 4: Backend API Implementation (`packages/api/`)**:

    -   Set up a basic ElysiaJS server.
    -   Implement the `POST /register` and `POST /login` endpoints, including all cryptographic and database operations.
    -   Implement the remaining endpoints for groups and data management.
    -   Create a `Dockerfile` for the `api` service.

5.  **Step 5: Frontend Web App Implementation (`packages/web/`)**:

    -   Set up a new React project using Vite.
    -   Create the Register, Login, and Dashboard pages.
    -   Implement the logic to call the backend API and handle JWTs.
    -   Create a `Dockerfile` for the `web` service.

6.  **Step 6: Deployment**:
    -   Write Kubernetes deployment and service manifests for the `api` and `web` services. These can be integrated into the Terraform setup.
    -   Set up a CI/CD pipeline (e.g., GitHub Actions) to build and push Docker images to the Scaleway Container Registry and apply the Kubernetes manifests upon changes to the main branch.
