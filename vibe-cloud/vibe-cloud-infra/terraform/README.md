# Vibe Cloud Shared Infrastructure on Scaleway (Terraform)

This directory contains Terraform configurations to provision and manage the shared infrastructure for the Vibe Cloud service on Scaleway. This includes:

-   A Scaleway Kapsule Kubernetes cluster.
-   A VPC Private Network.
-   Traefik Ingress Controller (via Helm).
-   Cert-Manager for automated SSL certificates (via Helm).
-   A Let's Encrypt ClusterIssuer for Cert-Manager.

This setup provides the foundational cluster where the Vibe Control Plane and individual Vibe instances (in separate namespaces) will be deployed.

## Prerequisites

Before you begin, ensure you have the following:

1.  **Scaleway Account:**

    -   A Scaleway account.
    -   **API Key:** Generate an Access Key and Secret Key from the Scaleway console (Project Dashboard -> Credentials -> API Keys).
    -   **Organization ID:** Find this in your Scaleway console (usually under your account name or Organization settings).
    -   **Project ID:** The ID of the Scaleway Project where resources will be created (Project Dashboard -> Copy ID).

2.  **Terraform:**

    -   Install Terraform (version 1.0 or higher recommended).
    -   Installation guide: [Install Terraform](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)

3.  **kubectl:**

    -   Install `kubectl`, the Kubernetes command-line tool.
    -   Installation guide: [Install kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)

4.  **jq (Optional but Recommended):**
    -   A command-line JSON processor, useful for extracting the kubeconfig.
    -   Installation guide: [jq Download](https://jqlang.github.io/jq/download/)

## Configuration Overview

-   `main.tf`: Defines all Scaleway and Kubernetes resources managed by Terraform. It includes variables for `project_id` and `letsencrypt_email` and outputs the `kubeconfig`.
-   `.gitignore`: Specifies intentionally untracked files.
-   `vibe-cluster.kubeconfig` (Generated by Terraform, Ignored by Git): The kubeconfig file for accessing the cluster. **DO NOT COMMIT THIS FILE.**
-   `.terraform.lock.hcl` (Generated by `terraform init`, Should be committed): Locks dependency versions for providers.

## Deployment Steps

1.  **Clone the Repository:**
    If you haven't already, clone the main Vibe project repository.

2.  **Navigate to this Terraform Directory:**

    ```bash
    cd path/to/vibe/vibe-cloud/vibe-cloud-infra/terraform
    ```

3.  **Set Up Scaleway Credentials and Variables:**
    Terraform needs your Scaleway API credentials and specific variables for deployment. The recommended way is to use environment variables for credentials and command-line flags for other variables.

    **Required Environment Variables:**

    ```bash
    export SCW_ACCESS_KEY="your_scaleway_access_key"
    export SCW_SECRET_KEY="your_scaleway_secret_key"
    export SCW_DEFAULT_ORGANIZATION_ID="your_scaleway_organization_id"
    export SCW_DEFAULT_PROJECT_ID="your_scaleway_project_id" # This is the Project UUID
    export SCW_DEFAULT_REGION="fr-par" # Or your preferred region: nl-ams, pl-waw
    ```

    (For Windows CMD, use `set` instead of `export`. For PowerShell, use `$env:VAR_NAME="value"`).

    **Required Terraform Variables (passed via `-var` flag):**

    -   `project_id`: Your Scaleway Project ID (UUID). This must match `SCW_DEFAULT_PROJECT_ID`.
    -   `letsencrypt_email`: Your email address for Let's Encrypt SSL certificate registration.

4.  **Initialize Terraform:**
    This downloads the necessary provider plugins. Run this once per new checkout or if `main.tf` changes its provider requirements.

    ```bash
    terraform init
    ```

5.  **Plan the Deployment (Optional but Recommended):**
    Review the changes Terraform will make.

    ```bash
    terraform plan -var="project_id=YOUR_PROJECT_ID_UUID" -var="letsencrypt_email=your_email@example.com"
    ```

    (Replace placeholders with your actual values).

6.  **Apply the Configuration:**
    This provisions the resources on Scaleway.

    ```bash
    terraform apply -var="project_id=YOUR_PROJECT_ID_UUID" -var="letsencrypt_email=your_email@example.com" -auto-approve
    ```

    (Replace placeholders. The `-auto-approve` flag skips interactive confirmation).
    This process can take several minutes.

    **Troubleshooting Initial Apply:**
    If `terraform apply` fails during initial cluster creation with errors related to the Kubernetes provider (e.g., "connection refused" to localhost), it might be because the Kubernetes API is not yet ready when dependent resources (like namespaces or Helm releases) are being configured.
    Try a two-stage apply:

    ```bash
    # Stage 1: Create only Scaleway Kapsule cluster and related network resources
    terraform apply \
      -var="project_id=YOUR_PROJECT_ID_UUID" \
      -var="letsencrypt_email=your_email@example.com" \
      -auto-approve \
      -target=scaleway_vpc_private_network.vibe-pn \
      -target=scaleway_k8s_cluster.vibe-cluster \
      -target=scaleway_k8s_pool.vibe-pool

    # Stage 2: Apply the rest (namespaces, Helm releases for Traefik/Cert-Manager, ClusterIssuer)
    terraform apply \
      -var="project_id=YOUR_PROJECT_ID_UUID" \
      -var="letsencrypt_email=your_email@example.com" \
      -auto-approve
    ```

## Accessing the Kubernetes Cluster

1.  **Retrieve Kubeconfig:**
    After `terraform apply` successfully completes, save the kubeconfig:

    ```bash
    terraform output -json kubeconfig | jq -r '.[0].config_file' > vibe-cluster.kubeconfig
    ```

    (Requires `jq` to be installed).
    The `vibe-cluster.kubeconfig` file is gitignored.

2.  **Configure `kubectl`:**
    Set the `KUBECONFIG` environment variable for your current terminal session:

    ```bash
    export KUBECONFIG=$(pwd)/vibe-cluster.kubeconfig
    ```

3.  **Verify Cluster Access:**
    ```bash
    kubectl get nodes
    kubectl get pods -A # View all system pods
    ```

## Post-Terraform Setup: Deploying Applications

This Terraform setup only provisions the shared cluster infrastructure. To deploy applications like the Vibe Control Plane:

1.  **Deploy System Database (CouchDB):**
    The Vibe Control Plane requires a CouchDB instance. This is typically deployed via Helm into the cluster. Refer to the main project documentation or `../kubernetes/control-plane-db/` (if such a directory exists with Helm instructions).

2.  **Deploy Vibe Control Plane:**
    The Kubernetes manifests for the control plane are located in `../kubernetes/control-plane/`.
    -   **Templated Files:**
        -   `04-secrets.yaml.template`: Contains placeholders for secrets. Copy it to `04-secrets.yaml` (gitignored) and populate with actual base64-encoded secret values.
        -   `07-ingress.yaml.template`: Contains a placeholder for the hostname. Copy it to `07-ingress.yaml` (gitignored) and set your desired hostname (e.g., `cp.yourdomain.com`). Ensure DNS for this hostname points to the Traefik LoadBalancer IP.
    -   **Apply Manifests:**
        ```bash
        kubectl apply -f ../kubernetes/control-plane/
        ```
        (Ensure your `KUBECONFIG` is set).

## Destroying Infrastructure

To remove all resources created by this Terraform configuration:

1.  Ensure your Scaleway environment variables are set as for the `apply` command.
2.  Navigate to this directory (`vibe-cloud/vibe-cloud-infra/terraform`).
3.  Run:
    ```bash
    terraform destroy -var="project_id=YOUR_PROJECT_ID_UUID" -var="letsencrypt_email=your_email@example.com" -auto-approve
    ```
    (Replace placeholders). This will delete the Kapsule cluster, node pool, VPC, and any LoadBalancers/Volumes created by Terraform for these resources. It will NOT delete resources created manually or by `kubectl apply` within the cluster unless those resources are managed by Terraform (which the control plane manifests are not).
